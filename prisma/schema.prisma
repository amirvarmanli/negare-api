generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["analytics", "catalog", "core", "finance", "public"]
}

model User {
  id                          String                               @id @default(uuid()) @db.Uuid
  createdAt                   DateTime                             @default(now()) @db.Timestamptz(6)
  updatedAt                   DateTime                             @updatedAt @db.Timestamptz(6)
  username                    String?                              @unique @db.Citext
  email                       String?                              @unique @db.Citext
  phone                       String?                              @unique @db.VarChar(32)
  name                        String?                              @db.VarChar(255)
  bio                         String?
  city                        String?                              @db.VarChar(255)
  avatarUrl                   String?                              @db.VarChar(255)
  passwordHash                String?                              @db.VarChar(255)
  isEmailVerified             Boolean                              @default(false)
  isPhoneVerified             Boolean                              @default(false)
  status                      UserStatus                           @default(active)
  passwordChangedAt           DateTime?                            @db.Timestamptz(6)
  lastLoginAt                 DateTime?                            @db.Timestamptz(6)
  deletedAt                   DateTime?                            @db.Timestamptz(6)
  downloads                   ProductDownload[]
  productViews                ProductView[]
  bookmarks                   Bookmark[]
  comments                    Comment[]
  likes                       Like[]
  artistFollowings            ArtistFollow[]                       @relation("ArtistFollowFollower")
  artistFollowers             ArtistFollow[]                       @relation("ArtistFollowArtist")
  productSuppliers            ProductSupplier[]                    @relation("ProductSuppliersUser")
  auditLogs                   AuditLog[]
  passwordResetTokens         PasswordResetToken[]
  sessions                    Session[]
  userRoles                   UserRole[]
  walletAuditLogs             WalletAuditLog[]
  createdTransactions         WalletTransaction[]                  @relation("WalletTransactionsCreatedBy")
  walletTransactions          WalletTransaction[]                  @relation("WalletTransactionsUser")
  wallet                      Wallet?
  skills                      UserSkill[]
  BlogPost                    BlogPost[]
  BlogComment                 BlogComment[]
  NewsletterIssue             NewsletterIssue[]
  NewsletterComment           NewsletterComment[]
  financeProductContributions FinanceProductContributor[]          @relation("FinanceProductContributor_supplier")
  financeOrders               FinanceOrder[]                       @relation("FinanceOrder_user")
  financePayments             FinancePayment[]                     @relation("FinancePayment_user")
  financeWalletTransactions   FinanceWalletTransaction[]           @relation("FinanceWalletTransaction_user")
  financeWallet               FinanceWallet?                       @relation("FinanceWallet_user")
  financeEntitlements         FinanceEntitlement[]                 @relation("FinanceEntitlement_user")
  financeDownloadUsage        FinanceDownloadUsageDaily[]          @relation("FinanceDownloadUsageDaily_user")
  financeDownloadLogs         FinanceDownloadLog[]                 @relation("FinanceDownloadLog_user")
  financeSubscriptions        FinanceUserSubscription[]            @relation("FinanceUserSubscription_user")
  financeSubscriptionPurchases FinanceSubscriptionPurchase[]
  financeSubscriptionEarnings FinanceSubscriptionSupplierEarning[] @relation("FinanceSubscriptionSupplierEarning_supplier")
  financeUserDiscounts        FinanceUserDiscount[]
  financeCouponRedemptions    FinanceCouponRedemption[]
  financeSupplierPayouts      FinanceSupplierPayout[]
  financeCart                 FinanceCart?                         @relation("FinanceCart_user")
  financeDonations            FinanceDonation[]                    @relation("FinanceDonation_user")

  @@index([status])
  @@index([createdAt], map: "users_created_at_idx")
  @@map("users")
  @@schema("core")
}

model Session {
  id               String               @id @default(uuid()) @db.Uuid
  userId           String               @db.Uuid
  refreshJti       String               @unique @db.Uuid
  refreshTokenHash String               @db.VarChar(255)
  uaHash           String?              @db.VarChar(64)
  ipHash           String?              @db.VarChar(64)
  fingerprintHash  String?              @db.VarChar(64)
  createdAt        DateTime             @default(now()) @db.Timestamptz(6)
  lastUsedAt       DateTime             @default(now()) @db.Timestamptz(6)
  expiresAt        DateTime             @db.Timestamptz(6)
  revokedAt        DateTime?            @db.Timestamptz(6)
  revokeReason     SessionRevokeReason?
  rotatedFromJti   String?              @db.Uuid
  user             User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, revokedAt], map: "session_user_active_idx")
  @@index([expiresAt], map: "session_expiry_idx")
  @@map("sessions")
  @@schema("core")
}

model PasswordResetToken {
  id        String    @id @default(uuid()) @db.Uuid
  userId    String    @db.Uuid
  tokenHash String    @unique @db.VarChar(255)
  createdAt DateTime  @default(now()) @db.Timestamptz(6)
  expiresAt DateTime  @db.Timestamptz(6)
  usedAt    DateTime? @db.Timestamptz(6)
  uaHash    String?   @db.VarChar(64)
  ipHash    String?   @db.VarChar(64)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([expiresAt], map: "pwd_reset_expiry_idx")
  @@map("password_reset_tokens")
  @@schema("core")
}

model AuditLog {
  id        String      @id @default(uuid()) @db.Uuid
  userId    String?     @db.Uuid
  action    AuditAction
  meta      Json?
  ipHash    String?     @db.VarChar(64)
  uaHash    String?     @db.VarChar(64)
  traceId   String?     @db.VarChar(64)
  createdAt DateTime    @default(now()) @db.Timestamptz(6)
  user      User?       @relation(fields: [userId], references: [id])

  @@index([createdAt], map: "audit_created_at_idx")
  @@index([userId, createdAt], map: "audit_user_time_idx")
  @@map("audit_logs")
  @@schema("core")
}

model Role {
  id        String     @id @default(uuid()) @db.Uuid
  createdAt DateTime   @default(now()) @db.Timestamptz(6)
  updatedAt DateTime   @updatedAt @db.Timestamptz(6)
  name      RoleName   @unique
  userRoles UserRole[]

  @@map("roles")
  @@schema("core")
}

model UserRole {
  id        String   @id @default(uuid()) @db.Uuid
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)
  userId    String   @map("user_id") @db.Uuid
  roleId    String   @map("role_id") @db.Uuid
  role      Role     @relation(fields: [roleId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, roleId])
  @@map("user_roles")
  @@schema("core")
}

model Wallet {
  id           String              @id @default(uuid()) @db.Uuid
  createdAt    DateTime            @default(now()) @db.Timestamptz(6)
  updatedAt    DateTime            @updatedAt @db.Timestamptz(6)
  userId       String              @unique @map("user_id") @db.Uuid
  balance      Decimal             @default(0) @db.Decimal(18, 2)
  currency     WalletCurrency      @default(IRR)
  auditLogs    WalletAuditLog[]
  transactions WalletTransaction[]
  user         User                @relation(fields: [userId], references: [id])

  @@map("wallets")
  @@schema("core")
}

model WalletTransaction {
  id             String                   @id @default(uuid()) @db.Uuid
  createdAt      DateTime                 @default(now()) @db.Timestamptz(6)
  updatedAt      DateTime                 @updatedAt @db.Timestamptz(6)
  walletId       String                   @map("wallet_id") @db.Uuid
  userId         String                   @map("user_id") @db.Uuid
  type           WalletTransactionType
  status         WalletTransactionStatus  @default(pending)
  amount         Decimal                  @db.Decimal(18, 2)
  balanceAfter   Decimal                  @default(0) @map("balance_after") @db.Decimal(18, 2)
  refType        WalletTransactionRefType @map("ref_type")
  refId          String?                  @map("ref_id") @db.VarChar(255)
  description    String?                  @db.VarChar(1000)
  idempotencyKey String                   @map("idempotency_key") @db.VarChar(255)
  externalRef    String?                  @map("external_ref") @db.VarChar(255)
  provider       String?                  @db.VarChar(64)
  groupId        String?                  @map("group_id") @db.Uuid
  metadata       Json?
  createdById    String?                  @map("created_by_id") @db.Uuid
  createdBy      User?                    @relation("WalletTransactionsCreatedBy", fields: [createdById], references: [id])
  user           User                     @relation("WalletTransactionsUser", fields: [userId], references: [id])
  wallet         Wallet                   @relation(fields: [walletId], references: [id])

  @@unique([walletId, idempotencyKey], map: "UQ_wallet_tx_wallet_idempotency")
  @@index([createdAt], map: "IDX_wallet_transactions_created_at")
  @@index([status], map: "IDX_wallet_transactions_status")
  @@index([groupId], map: "IDX_wallet_transactions_group_id")
  @@index([userId], map: "IDX_wallet_transactions_user_id")
  @@map("wallet_transactions")
  @@schema("core")
}

model WalletAuditLog {
  id        String   @id @default(uuid()) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  userId    String?  @map("user_id") @db.Uuid
  walletId  String?  @map("wallet_id") @db.Uuid
  action    String   @db.VarChar(64)
  meta      Json?
  user      User?    @relation(fields: [userId], references: [id])
  wallet    Wallet?  @relation(fields: [walletId], references: [id])

  @@index([userId, createdAt], map: "IDX_wallet_audit_user_created")
  @@index([walletId, createdAt], map: "IDX_wallet_audit_wallet_created")
  @@map("wallet_audit_logs")
  @@schema("core")
}

model Skill {
  id          String      @id @default(uuid()) @db.Uuid
  createdAt   DateTime    @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime    @updatedAt @db.Timestamptz(6)
  key         String      @unique @db.VarChar(64)
  nameFa      String      @db.VarChar(255)
  nameEn      String?     @db.VarChar(255)
  description String?     @db.VarChar(1000)
  isActive    Boolean     @default(true)
  sortOrder   Int         @default(0)
  userLinks   UserSkill[]

  @@map("skills")
  @@schema("core")
}

model UserSkill {
  userId    String   @map("user_id") @db.Uuid
  skillId   String   @map("skill_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  skill Skill @relation(fields: [skillId], references: [id], onDelete: Restrict)

  @@id([userId, skillId])
  @@index([skillId], map: "user_skills_skill_idx")
  @@map("user_skills")
  @@schema("core")
}

model File {
  id           String        @id @default(uuid())
  userId       String
  filename     String
  mime         String
  size         BigInt
  path         String
  url          String
  status       String        @default("uploaded")
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  productFiles ProductFile[]

  @@index([userId, createdAt])
  @@schema("core")
}

model Product {
  id                         BigInt                      @id @default(autoincrement())
  slug                       String                      @unique @db.VarChar(200)
  title                      String                      @db.VarChar(255)
  description                String?                     @db.VarChar(1400)
  coverUrl                   String?                     @db.VarChar(255)
  graphicFormats             GraphicFormat[]             @default([])
  colors                     String[]                    @default([])
  shortLink                  String?                     @unique @db.VarChar(80)
  seoTitle                   String?                     @db.VarChar(250)
  seoDescription             String?                     @db.VarChar(1400)
  seoKeywords                String[]                    @default([])
  searchTextNormalized       String?                     @map("search_text_normalized") @db.Text
  pricingType                PricingType
  price                      Decimal?                    @db.Decimal(12, 2)
  status                     ProductStatus               @default(DRAFT)
  publishedAt                DateTime?                   @db.Timestamptz(6)
  viewsCount                 Int                         @default(0)
  downloadsCount             Int                         @default(0)
  likesCount                 Int                         @default(0)
  fileSizeMB                 Int                         @default(0)
  fileBytes                  BigInt?
  createdAt                  DateTime                    @default(now()) @db.Timestamptz(6)
  updatedAt                  DateTime                    @updatedAt @db.Timestamptz(6)
  downloads                  ProductDownload[]
  views                      ProductView[]
  bookmarks                  Bookmark[]
  comments                   Comment[]                   @relation("ProductComments")
  likes                      Like[]
  assets                     ProductAsset[]
  categoryLinks              ProductCategory[]
  supplierLinks              ProductSupplier[]           @relation("ProductSuppliersProduct")
  tagLinks                   ProductTag[]
  topics                     ProductTopic[]
  file                       ProductFile?
  financeProductContributors FinanceProductContributor[] @relation("FinanceProductContributor_product")
  financeOrderItems          FinanceOrderItem[]          @relation("FinanceOrderItem_product")
  financeEntitlements        FinanceEntitlement[]        @relation("FinanceEntitlement_product")
  financeDownloadLogs        FinanceDownloadLog[]        @relation("FinanceDownloadLog_product")
  financeOrderRevenueSplits  FinanceOrderRevenueSplit[]  @relation("FinanceOrderRevenueSplit_product")
  financeProductDiscounts    FinanceProductDiscount[]
  financeCartItems           FinanceCartItem[]           @relation("FinanceCartItem_product")

  @@index([status, pricingType], map: "products_status_pricing_idx")
  @@index([createdAt], map: "products_created_at_idx")
  @@map("products")
  @@schema("catalog")
}

model ProductAsset {
  id        BigInt   @id @default(autoincrement())
  productId BigInt   @map("product_id")
  url       String   @db.VarChar(255)
  alt       String?  @db.VarChar(255)
  sortOrder Int      @default(0) @map("order")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  product   Product  @relation(fields: [productId], references: [id])

  @@map("product_assets")
  @@schema("catalog")
}

model ProductFile {
  id           BigInt   @id @default(autoincrement())
  productId    BigInt   @unique @map("product_id")
  fileUuid     String?  @map("file_id")
  storageKey   String   @db.VarChar(255)
  originalName String?  @db.VarChar(255)
  size         BigInt?
  mimeType     String?  @db.VarChar(255)
  meta         Json?
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  product      Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  sourceFile   File?    @relation(fields: [fileUuid], references: [id], onDelete: SetNull)

  @@map("product_files")
  @@schema("catalog")
}

model Category {
  id           BigInt            @id @default(autoincrement())
  name         String            @db.VarChar(255)
  slug         String            @unique @db.VarChar(200)
  parentId     BigInt?           @map("parent_id")
  coverUrl     String?           @db.VarChar(255)
  parent       Category?         @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children     Category[]        @relation("CategoryHierarchy")
  productLinks ProductCategory[]

  @@index([parentId], map: "categories_parent_idx")
  @@map("categories")
  @@schema("catalog")
}

model ProductCategory {
  productId  BigInt   @map("product_id")
  categoryId BigInt   @map("category_id")
  category   Category @relation(fields: [categoryId], references: [id])
  product    Product  @relation(fields: [productId], references: [id])

  @@id([productId, categoryId])
  @@index([categoryId], map: "product_categories_category_idx")
  @@map("product_categories")
  @@schema("catalog")
}

model Tag {
  id           BigInt       @id @default(autoincrement())
  name         String       @unique @db.VarChar(255)
  slug         String       @unique @db.VarChar(255)
  productLinks ProductTag[]

  @@map("tags")
  @@schema("catalog")
}

model ProductTag {
  productId BigInt  @map("product_id")
  tagId     BigInt  @map("tag_id")
  product   Product @relation(fields: [productId], references: [id])
  tag       Tag     @relation(fields: [tagId], references: [id])

  @@id([productId, tagId])
  @@index([tagId], map: "product_tags_tag_idx")
  @@map("product_tags")
  @@schema("catalog")
}

model ProductSupplier {
  productId BigInt  @map("product_id")
  userId    String  @map("user_id") @db.Uuid
  product   Product @relation("ProductSuppliersProduct", fields: [productId], references: [id])
  user      User    @relation("ProductSuppliersUser", fields: [userId], references: [id])

  @@id([productId, userId])
  @@map("product_suppliers")
  @@schema("catalog")
}

model Topic {
  id             BigInt         @id @default(autoincrement())
  name           String         @unique @db.VarChar(120)
  slug           String         @unique @db.VarChar(200)
  coverUrl       String?        @db.VarChar(255)
  seoTitle       String?        @db.VarChar(160)
  seoDescription String?        @db.VarChar(550)
  productLinks   ProductTopic[]

  @@map("topics")
  @@schema("catalog")
}

model ProductTopic {
  productId BigInt  @map("product_id")
  topicId   BigInt  @map("topic_id")
  order     Int     @default(0) @map("order")
  product   Product @relation(fields: [productId], references: [id])
  topic     Topic   @relation(fields: [topicId], references: [id])

  @@id([productId, topicId])
  @@index([topicId], map: "product_topics_topic_idx")
  @@map("product_topics")
  @@schema("catalog")
}

model SlugRedirect {
  id         String   @id @default(cuid())
  entityType String   @db.VarChar(32)
  entityId   String   @db.VarChar(64)
  fromSlug   String   @unique @db.VarChar(200)
  toSlug     String   @db.VarChar(200)
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([entityType, entityId], map: "slug_redirect_entity_idx")
  @@map("slug_redirects")
  @@schema("catalog")
}

model Bookmark {
  userId    String   @map("user_id") @db.Uuid
  productId BigInt   @map("product_id")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  product   Product  @relation(fields: [productId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@id([userId, productId])
  @@index([userId, createdAt], map: "bookmarks_user_time_idx")
  @@map("bookmarks")
  @@schema("catalog")
}

model Like {
  userId    String   @map("user_id") @db.Uuid
  productId BigInt   @map("product_id")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  product   Product  @relation(fields: [productId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@id([userId, productId])
  @@index([productId], map: "likes_product_idx")
  @@index([userId, createdAt], map: "likes_user_time_idx")
  @@map("likes")
  @@schema("catalog")
}

model ArtistFollow {
  followerId String   @map("follower_id") @db.Uuid
  artistId   String   @map("artist_id") @db.Uuid
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  follower   User     @relation("ArtistFollowFollower", fields: [followerId], references: [id], onDelete: Cascade)
  artist     User     @relation("ArtistFollowArtist", fields: [artistId], references: [id], onDelete: Cascade)

  @@id([followerId, artistId])
  @@index([artistId, createdAt], map: "artist_follows_artist_time_idx")
  @@index([followerId, createdAt], map: "artist_follows_follower_time_idx")
  @@map("artist_follows")
  @@schema("catalog")
}

model Comment {
  id         BigInt        @id @default(autoincrement())
  userId     String        @map("user_id") @db.Uuid
  body       String
  isApproved Boolean       @default(true)
  targetType CommentTarget
  targetId   String        @db.VarChar(64)
  productId  BigInt?       @map("product_id")
  parentId   BigInt?       @map("parent_id")
  createdAt  DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime      @updatedAt @map("updated_at") @db.Timestamptz(6)
  parent     Comment?      @relation("CommentThread", fields: [parentId], references: [id])
  children   Comment[]     @relation("CommentThread")
  product    Product?      @relation("ProductComments", fields: [productId], references: [id])
  user       User          @relation(fields: [userId], references: [id])

  @@index([targetType, targetId, createdAt], map: "comments_target_time_idx")
  @@index([productId, createdAt], map: "comments_product_time_idx")
  @@map("comments")
  @@schema("catalog")
}

model BlogCategory {
  id          String         @id @default(uuid()) @db.Uuid
  name        String         @db.VarChar(255)
  slug        String         @unique @db.Citext
  description String?        @db.VarChar(1000)
  isActive    Boolean        @default(true) @map("is_active")
  parentId    String?        @map("parent_id") @db.Uuid
  createdAt   DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime       @updatedAt @map("updated_at") @db.Timestamptz(6)
  parent      BlogCategory?  @relation("BlogCategoryHierarchy", fields: [parentId], references: [id])
  children    BlogCategory[] @relation("BlogCategoryHierarchy")
  posts       BlogPost[]

  @@index([isActive], map: "blog_categories_active_idx")
  @@map("blog_categories")
  @@schema("catalog")
}

model BlogPost {
  id              String            @id @default(uuid()) @db.Uuid
  title           String            @db.VarChar(255)
  slug            String            @unique @db.Citext
  browserTitle    String?           @map("browser_title") @db.VarChar(70)
  excerpt         String?           @db.VarChar(600)
  content         String
  coverImageUrl   String?           @map("cover_image_url") @db.VarChar(1024)
  previewCoverUrl String?           @map("preview_cover_url") @db.VarChar(1024)
  isFeatured      Boolean           @default(false) @map("is_featured")
  isPinned        Boolean           @default(false) @map("is_pinned")
  viewCount       Int               @default(0) @map("view_count")
  status          PublicationStatus @default(DRAFT)
  publishedAt     DateTime?         @map("published_at") @db.Timestamptz(6)
  createdAt       DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime          @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt       DateTime?         @map("deleted_at") @db.Timestamptz(6)
  categoryId      String            @map("category_id") @db.Uuid
  authorId        String            @map("author_id") @db.Uuid
  category        BlogCategory      @relation(fields: [categoryId], references: [id])
  author          User              @relation(fields: [authorId], references: [id])
  comments        BlogComment[]
  sections        BlogPostSection[]

  @@index([status, publishedAt], map: "blog_posts_status_pub_idx")
  @@index([categoryId], map: "blog_posts_category_idx")
  @@map("blog_posts")
  @@schema("catalog")
}

model BlogComment {
  id        String        @id @default(uuid()) @db.Uuid
  postId    String        @map("post_id") @db.Uuid
  authorId  String        @map("author_id") @db.Uuid
  parentId  String?       @map("parent_id") @db.Uuid
  content   String        @db.VarChar(2000)
  status    CommentStatus @default(PENDING)
  createdAt DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime      @updatedAt @map("updated_at") @db.Timestamptz(6)
  author    User          @relation(fields: [authorId], references: [id])
  post      BlogPost      @relation(fields: [postId], references: [id])
  parent    BlogComment?  @relation("BlogCommentThread", fields: [parentId], references: [id])
  replies   BlogComment[] @relation("BlogCommentThread")

  @@index([postId, status, createdAt], map: "blog_comments_post_status_idx")
  @@map("blog_comments")
  @@schema("catalog")
}

model BlogPostSection {
  id         String                @id @default(uuid()) @db.Uuid
  blogPostId String                @map("blog_post_id") @db.Uuid
  order      Int
  title      String                @db.VarChar(255)
  body       String
  mediaUrl   String?               @map("media_url") @db.VarChar(1024)
  mediaType  BlogSectionMediaType? @map("media_type")
  createdAt  DateTime              @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime              @updatedAt @map("updated_at") @db.Timestamptz(6)
  blogPost   BlogPost              @relation(fields: [blogPostId], references: [id], onDelete: Cascade)

  @@index([blogPostId, order], map: "blog_post_sections_post_order_idx")
  @@map("blog_post_sections")
  @@schema("catalog")
}

enum BlogSectionMediaType {
  image
  video

  @@schema("catalog")
}

model NewsletterCategory {
  id          String               @id @default(uuid()) @db.Uuid
  name        String               @db.VarChar(255)
  slug        String               @unique @db.Citext
  description String?              @db.VarChar(1000)
  isActive    Boolean              @default(true) @map("is_active")
  parentId    String?              @map("parent_id") @db.Uuid
  createdAt   DateTime             @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime             @updatedAt @map("updated_at") @db.Timestamptz(6)
  parent      NewsletterCategory?  @relation("NewsletterCategoryHierarchy", fields: [parentId], references: [id])
  children    NewsletterCategory[] @relation("NewsletterCategoryHierarchy")
  issues      NewsletterIssue[]

  @@index([isActive], map: "newsletter_categories_active_idx")
  @@map("newsletter_categories")
  @@schema("catalog")
}

model NewsletterIssue {
  id            String              @id @default(uuid()) @db.Uuid
  title         String              @db.VarChar(255)
  slug          String              @unique @db.Citext
  browserTitle  String?             @map("browser_title") @db.VarChar(70)
  excerpt       String?             @db.VarChar(600)
  content       String
  coverImageUrl String?             @map("cover_image_url") @db.VarChar(1024)
  fileUrl       String?             @map("file_url") @db.VarChar(1024)
  isFeatured    Boolean             @default(false) @map("is_featured")
  isPinned      Boolean             @default(false) @map("is_pinned")
  viewCount     Int                 @default(0) @map("view_count")
  status        PublicationStatus   @default(DRAFT)
  publishedAt   DateTime?           @map("published_at") @db.Timestamptz(6)
  createdAt     DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime            @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt     DateTime?           @map("deleted_at") @db.Timestamptz(6)
  categoryId    String              @map("category_id") @db.Uuid
  authorId      String              @map("author_id") @db.Uuid
  category      NewsletterCategory  @relation(fields: [categoryId], references: [id])
  author        User                @relation(fields: [authorId], references: [id])
  comments      NewsletterComment[]
  sections      NewsletterSection[]

  @@index([status, publishedAt], map: "newsletter_issue_status_pub_idx")
  @@index([categoryId], map: "newsletter_issue_category_idx")
  @@map("newsletter_issues")
  @@schema("catalog")
}

model NewsletterComment {
  id        String              @id @default(uuid()) @db.Uuid
  issueId   String              @map("issue_id") @db.Uuid
  authorId  String              @map("author_id") @db.Uuid
  parentId  String?             @map("parent_id") @db.Uuid
  content   String              @db.VarChar(2000)
  status    CommentStatus       @default(PENDING)
  createdAt DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime            @updatedAt @map("updated_at") @db.Timestamptz(6)
  author    User                @relation(fields: [authorId], references: [id])
  issue     NewsletterIssue     @relation(fields: [issueId], references: [id])
  parent    NewsletterComment?  @relation("NewsletterCommentThread", fields: [parentId], references: [id])
  replies   NewsletterComment[] @relation("NewsletterCommentThread")

  @@index([issueId, status, createdAt], map: "newsletter_comments_issue_status_idx")
  @@map("newsletter_comments")
  @@schema("catalog")
}

model NewsletterSection {
  id        String          @id @default(uuid()) @db.Uuid
  issueId   String          @map("issue_id") @db.Uuid
  order     Int
  title     String          @db.VarChar(255)
  body      String
  createdAt DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime        @updatedAt @map("updated_at") @db.Timestamptz(6)
  issue     NewsletterIssue @relation(fields: [issueId], references: [id], onDelete: Cascade)

  @@index([issueId, order], map: "newsletter_sections_issue_order_idx")
  @@map("newsletter_sections")
  @@schema("catalog")
}

model ProductView {
  id        BigInt   @id @default(autoincrement())
  productId BigInt   @map("product_id")
  userId    String?  @map("user_id") @db.Uuid
  ip        String?  @db.VarChar(255)
  ua        String?  @db.VarChar(255)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  product   Product  @relation(fields: [productId], references: [id])
  user      User?    @relation(fields: [userId], references: [id])

  @@map("product_views")
  @@schema("analytics")
}

model ProductDownload {
  id        BigInt   @id @default(autoincrement())
  productId BigInt   @map("product_id")
  userId    String   @map("user_id") @db.Uuid
  bytes     BigInt?
  pricePaid Int?
  ip        String?  @db.VarChar(45)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  product   Product  @relation(fields: [productId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@index([productId, createdAt], map: "product_downloads_product_time_idx")
  @@index([userId, createdAt], map: "product_downloads_user_time_idx")
  @@map("product_downloads")
  @@schema("analytics")
}

enum RoleName {
  user
  supplier
  admin

  @@map("role_name_enum")
  @@schema("core")
}

enum WalletCurrency {
  IRR

  @@map("wallet_currency_enum")
  @@schema("core")
}

enum WalletTransactionType {
  credit
  debit

  @@map("wallet_transaction_type_enum")
  @@schema("core")
}

enum WalletTransactionStatus {
  pending
  completed
  failed

  @@map("wallet_transaction_status_enum")
  @@schema("core")
}

enum WalletTransactionRefType {
  order
  payout
  adjustment

  @@map("wallet_transaction_ref_type_enum")
  @@schema("core")
}

enum OtpChannel {
  sms
  email

  @@map("enum_otp_codes_channel")
  @@schema("core")
}

enum OtpStatus {
  active
  used
  expired
  blocked

  @@map("enum_otp_codes_status")
  @@schema("core")
}

enum OtpPurpose {
  signup
  login
  reset

  @@map("enum_otp_codes_purpose")
  @@schema("core")
}

enum UserStatus {
  active
  blocked
  pending

  @@schema("core")
}

enum SessionRevokeReason {
  logout
  rotation
  reuse_detected
  admin

  @@schema("core")
}

enum AuditAction {
  OTP_REQUEST
  OTP_VERIFY_SUCCESS
  OTP_VERIFY_FAIL
  LOGIN_SUCCESS
  LOGIN_FAIL
  REFRESH_ROTATE
  REFRESH_REUSE_DETECTED
  LOGOUT
  LOGOUT_ALL
  PASSWORD_SET
  PASSWORD_FORGOT_REQUEST
  PASSWORD_RESET_SUCCESS
  PASSWORD_RESET_FAIL

  @@schema("core")
}

enum PricingType {
  FREE
  PAID
  PAID_OR_SUBSCRIPTION

  @@map("enum_content_products_pricingType")
  @@schema("catalog")
}

enum ProductStatus {
  DRAFT
  PUBLISHED
  ARCHIVED

  @@map("enum_content_products_status")
  @@schema("catalog")
}

enum PublicationStatus {
  DRAFT
  PUBLISHED
  ARCHIVED

  @@map("enum_content_publication_status")
  @@schema("catalog")
}

enum CommentStatus {
  PENDING
  APPROVED
  REJECTED

  @@map("enum_content_comment_status")
  @@schema("catalog")
}

enum GraphicFormat {
  PSD
  EPS
  JPG
  PNG
  PDF
  MP4
  AI
  CDR
  TTF
  TIF
  SVG
  OBJ
  WEBP

  @@map("enum_content_products_graphicFormat")
  @@schema("catalog")
}

enum CommentTarget {
  PRODUCT
  POST
  NEWSLETTER

  @@map("enum_content_comment_target")
  @@schema("catalog")
}

enum FinanceOrderStatus {
  DRAFT
  PENDING_PAYMENT
  PAID
  CANCELLED
  FAILED
  EXPIRED

  @@map("finance_order_status_enum")
  @@schema("finance")
}

enum FinanceOrderKind {
  PRODUCT
  SUBSCRIPTION
  TOPUP

  @@map("finance_order_kind_enum")
  @@schema("finance")
}

enum FinanceDiscountType {
  NONE
  FIXED
  PERCENT
  COUPON

  @@map("finance_discount_type_enum")
  @@schema("finance")
}

enum FinanceDiscountValueType {
  FIXED
  PERCENT

  @@map("finance_discount_value_type_enum")
  @@schema("finance")
}

enum FinancePaymentProvider {
  MOCK
  ZIBAL

  @@map("finance_payment_provider_enum")
  @@schema("finance")
}

enum FinancePaymentStatus {
  PENDING
  SUCCESS
  FAILED
  CANCELED

  @@map("finance_payment_status_enum")
  @@schema("finance")
}

enum FinancePaymentPurpose {
  ORDER
  WALLET_TOPUP
  DONATION

  @@map("finance_payment_purpose_enum")
  @@schema("finance")
}

enum FinancePaymentReferenceType {
  cart
  subscription
  wallet_charge
  donation

  @@map("finance_payment_reference_type_enum")
  @@schema("finance")
}

enum FinanceDonationStatus {
  PENDING
  SUCCESS
  FAILED

  @@map("finance_donation_status_enum")
  @@schema("finance")
}

enum Messenger {
  telegram
  eitaa
  ble

  @@map("order_request_messenger_enum")
  @@schema("public")
}

enum OrderFileKind {
  IMAGE
  ZIP

  @@map("order_request_file_kind_enum")
  @@schema("public")
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  CANCELED

  @@map("order_request_payment_status_enum")
  @@schema("public")
}

enum OrderRequestPaymentPurpose {
  PHOTO_RESTORE

  @@map("order_request_payment_purpose_enum")
  @@schema("public")
}

enum FinanceWalletTransactionType {
  CREDIT
  DEBIT

  @@map("finance_wallet_transaction_type_enum")
  @@schema("finance")
}

enum FinanceWalletTransactionReason {
  TOPUP
  ORDER_PAYMENT
  REFUND
  ADJUSTMENT
  WITHDRAWAL

  @@map("finance_wallet_transaction_reason_enum")
  @@schema("finance")
}

enum FinanceWalletTransactionStatus {
  PENDING
  SUCCESS
  FAILED
  CANCELED

  @@map("finance_wallet_transaction_status_enum")
  @@schema("finance")
}

enum FinanceWalletStatus {
  ACTIVE
  SUSPENDED

  @@map("finance_wallet_status_enum")
  @@schema("finance")
}

enum FinanceEntitlementSource {
  PURCHASED
  SUB_QUOTA
  FREE_QUOTA

  @@map("finance_entitlement_source_enum")
  @@schema("finance")
}

enum FinanceSubscriptionPlanCode {
  A
  B
  C

  @@map("finance_subscription_plan_code_enum")
  @@schema("finance")
}

enum FinanceSubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED

  @@map("finance_subscription_status_enum")
  @@schema("finance")
}

enum FinanceSubscriptionPurchaseStatus {
  PENDING
  PAID
  FAILED
  CANCELED

  @@map("finance_subscription_purchase_status_enum")
  @@schema("finance")
}

enum FinanceRevenuePoolStatus {
  DRAFT
  COMPUTED
  OPEN
  FINALIZED

  @@map("finance_revenue_pool_status_enum")
  @@schema("finance")
}

enum FinancePayoutStatus {
  PENDING
  PAID
  FAILED

  @@map("finance_payout_status_enum")
  @@schema("finance")
}

enum FinanceEarningStatus {
  PENDING
  PAID

  @@map("finance_earning_status_enum")
  @@schema("finance")
}

enum FinanceRevenueBeneficiaryType {
  PLATFORM
  SUPPLIER

  @@map("finance_revenue_beneficiary_type_enum")
  @@schema("finance")
}

enum FinanceCartStatus {
  ACTIVE
  CHECKED_OUT
  ABANDONED

  @@map("finance_cart_status_enum")
  @@schema("finance")
}

model FinanceProductContributor {
  id            String  @id @default(uuid()) @db.Uuid
  productId     BigInt  @map("product_id")
  supplierId    String  @map("supplier_id") @db.Uuid
  supplierCount Int     @map("supplier_count")
  sharePercent  Int?    @map("share_percent")
  product       Product @relation("FinanceProductContributor_product", fields: [productId], references: [id])
  supplier      User    @relation("FinanceProductContributor_supplier", fields: [supplierId], references: [id])

  @@unique([productId, supplierId])
  @@map("product_contributors")
  @@schema("finance")
}

model FinanceCart {
  id        String            @id @default(uuid()) @db.Uuid
  userId    String            @unique @map("user_id") @db.Uuid
  status    FinanceCartStatus @default(ACTIVE)
  createdAt DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime          @updatedAt @map("updated_at") @db.Timestamptz(6)
  items     FinanceCartItem[]
  user      User              @relation("FinanceCart_user", fields: [userId], references: [id])

  @@index([userId])
  @@map("carts")
  @@schema("finance")
}

model FinanceCartItem {
  id        String      @id @default(uuid()) @db.Uuid
  cartId    String      @map("cart_id") @db.Uuid
  productId BigInt      @map("product_id")
  quantity  Int         @default(1)
  createdAt DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime    @updatedAt @map("updated_at") @db.Timestamptz(6)
  cart      FinanceCart @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product   Product     @relation("FinanceCartItem_product", fields: [productId], references: [id])

  @@unique([cartId, productId])
  @@index([cartId, productId])
  @@map("cart_items")
  @@schema("finance")
}

model FinanceOrder {
  id                         String                     @id @default(uuid()) @db.Uuid
  userId                     String                     @map("user_id") @db.Uuid
  status                     FinanceOrderStatus
  orderKind                  FinanceOrderKind           @map("order_kind")
  subtotal                   Int
  discountType               FinanceDiscountType        @map("discount_type")
  discountValue              Int                        @map("discount_value")
  total                      Int
  currency                   String                     @db.VarChar(8)
  subscriptionPlanId         String?                    @map("subscription_plan_id") @db.Uuid
  subscriptionDurationMonths Int?                       @map("subscription_duration_months")
  createdAt                  DateTime                   @default(now()) @map("created_at") @db.Timestamptz(6)
  paidAt                     DateTime?                  @map("paid_at") @db.Timestamptz(6)
  expiresAt                  DateTime?                  @map("expires_at") @db.Timestamptz(6)
  items                      FinanceOrderItem[]         @relation("FinanceOrder_items")
  payments                   FinancePayment[]           @relation("FinanceOrder_payments")
  revenueSplits              FinanceOrderRevenueSplit[] @relation("FinanceOrder_revenue_splits")
  couponRedemptions          FinanceCouponRedemption[]
  user                       User                       @relation("FinanceOrder_user", fields: [userId], references: [id])

  @@index([userId, createdAt])
  @@map("orders")
  @@schema("finance")
}

model FinanceProductDiscount {
  id        String                   @id @default(uuid()) @db.Uuid
  productId BigInt                   @map("product_id")
  type      FinanceDiscountValueType
  value     Int
  startsAt  DateTime?                @map("starts_at") @db.Timestamptz(6)
  endsAt    DateTime?                @map("ends_at") @db.Timestamptz(6)
  isActive  Boolean                  @default(true) @map("is_active")
  createdAt DateTime                 @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime                 @updatedAt @map("updated_at") @db.Timestamptz(6)
  product   Product                  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId, isActive])
  @@map("product_discounts")
  @@schema("finance")
}

model FinanceUserDiscount {
  id        String                   @id @default(uuid()) @db.Uuid
  userId    String                   @map("user_id") @db.Uuid
  type      FinanceDiscountValueType
  value     Int
  startsAt  DateTime?                @map("starts_at") @db.Timestamptz(6)
  endsAt    DateTime?                @map("ends_at") @db.Timestamptz(6)
  isActive  Boolean                  @default(true) @map("is_active")
  createdAt DateTime                 @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime                 @updatedAt @map("updated_at") @db.Timestamptz(6)
  user      User                     @relation(fields: [userId], references: [id])

  @@index([userId, isActive])
  @@map("user_discounts")
  @@schema("finance")
}

model FinanceCoupon {
  id              String                    @id @default(uuid()) @db.Uuid
  code            String                    @unique @db.VarChar(64)
  type            FinanceDiscountValueType
  value           Int
  maxUsage        Int?                      @map("max_usage")
  maxUsagePerUser Int?                      @map("max_usage_per_user")
  expiresAt       DateTime?                 @map("expires_at") @db.Timestamptz(6)
  isActive        Boolean                   @default(true) @map("is_active")
  createdAt       DateTime                  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime                  @updatedAt @map("updated_at") @db.Timestamptz(6)
  redemptions     FinanceCouponRedemption[]

  @@index([code, isActive])
  @@map("coupons")
  @@schema("finance")
}

model FinanceCouponRedemption {
  id        String        @id @default(uuid()) @db.Uuid
  couponId  String        @map("coupon_id") @db.Uuid
  userId    String        @map("user_id") @db.Uuid
  orderId   String        @map("order_id") @db.Uuid
  amount    Int
  createdAt DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  coupon    FinanceCoupon @relation(fields: [couponId], references: [id], onDelete: Cascade)
  order     FinanceOrder  @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user      User          @relation(fields: [userId], references: [id])

  @@unique([couponId, orderId])
  @@index([couponId, userId])
  @@map("coupon_redemptions")
  @@schema("finance")
}

model FinanceOrderItem {
  id                  String       @id @default(uuid()) @db.Uuid
  orderId             String       @map("order_id") @db.Uuid
  productId           BigInt       @map("product_id")
  unitPriceSnapshot   Int          @map("unit_price_snapshot")
  quantity            Int
  lineTotal           Int          @map("line_total")
  productTypeSnapshot PricingType  @map("product_type_snapshot")
  createdAt           DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  order               FinanceOrder @relation("FinanceOrder_items", fields: [orderId], references: [id], onDelete: Cascade)
  product             Product      @relation("FinanceOrderItem_product", fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
  @@schema("finance")
}

model FinancePayment {
  id         String                 @id @default(uuid()) @db.Uuid
  orderId    String?                @map("order_id") @db.Uuid
  userId     String                 @map("user_id") @db.Uuid
  purpose    FinancePaymentPurpose  @default(ORDER)
  referenceType FinancePaymentReferenceType? @map("reference_type")
  referenceId   String?             @map("reference_id") @db.VarChar(128)
  provider   FinancePaymentProvider
  status     FinancePaymentStatus
  amount     Int
  currency   String                 @db.VarChar(8)
  trackId    String?                @unique @map("track_id") @db.VarChar(128)
  authority  String?                @db.VarChar(128)
  refId      String?                @map("ref_id") @db.VarChar(128)
  failureReason String?             @map("failure_reason") @db.VarChar(512)
  createdAt  DateTime               @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime               @updatedAt @map("updated_at") @db.Timestamptz(6)
  verifiedAt DateTime?              @map("verified_at") @db.Timestamptz(6)
  paidAt     DateTime?              @map("paid_at") @db.Timestamptz(6)
  meta       Json?
  order      FinanceOrder?          @relation("FinanceOrder_payments", fields: [orderId], references: [id])
  subscriptionPurchases FinanceSubscriptionPurchase[]
  user       User                   @relation("FinancePayment_user", fields: [userId], references: [id])

  @@index([userId, createdAt])
  @@index([orderId], map: "payments_order_id_idx")
  @@index([status], map: "payments_status_idx")
  @@index([referenceType, referenceId], map: "payments_reference_idx")
  @@map("payments")
  @@schema("finance")
}

model FinanceWallet {
  id        String             @id @default(uuid()) @db.Uuid
  userId    String             @unique @map("user_id") @db.Uuid
  balance   Int                @default(0)
  currency  String             @default("TOMAN") @db.VarChar(8)
  status    FinanceWalletStatus @default(ACTIVE)
  createdAt DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime           @updatedAt @map("updated_at") @db.Timestamptz(6)
  transactions FinanceWalletTransaction[]
  user      User               @relation("FinanceWallet_user", fields: [userId], references: [id])

  @@map("wallets")
  @@schema("finance")
}

model FinanceWalletTransaction {
  id             String                        @id @default(uuid()) @db.Uuid
  walletId       String                        @map("wallet_id") @db.Uuid
  userId         String                        @map("user_id") @db.Uuid
  type           FinanceWalletTransactionType
  reason         FinanceWalletTransactionReason
  status         FinanceWalletTransactionStatus @default(PENDING)
  amount         Int
  balanceAfter   Int?                          @map("balance_after")
  referenceId    String?                       @map("reference_id") @db.VarChar(128)
  description    String?                       @db.VarChar(1000)
  idempotencyKey String?                       @map("idempotency_key") @db.VarChar(255)
  createdAt      DateTime                      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime                      @updatedAt @map("updated_at") @db.Timestamptz(6)
  user           User                          @relation("FinanceWalletTransaction_user", fields: [userId], references: [id])
  wallet         FinanceWallet                 @relation(fields: [walletId], references: [id])

  @@unique([walletId, idempotencyKey], map: "UQ_finance_wallet_tx_idempotency")
  @@index([userId, createdAt])
  @@index([walletId, createdAt])
  @@index([referenceId])
  @@map("wallet_transactions")
  @@schema("finance")
}

model FinanceEntitlement {
  id        String                   @id @default(uuid()) @db.Uuid
  userId    String                   @map("user_id") @db.Uuid
  productId BigInt                   @map("product_id")
  source    FinanceEntitlementSource
  orderId   String?                  @map("order_id") @db.Uuid
  purchasedAt DateTime               @default(now()) @map("purchased_at") @db.Timestamptz(6)
  createdAt   DateTime               @default(now()) @map("created_at") @db.Timestamptz(6)
  user      User                     @relation("FinanceEntitlement_user", fields: [userId], references: [id])
  product   Product                  @relation("FinanceEntitlement_product", fields: [productId], references: [id])

  @@unique([userId, productId], map: "entitlements_user_id_product_id_key")
  @@index([userId, purchasedAt], map: "entitlements_user_purchased_idx")
  @@index([orderId], map: "entitlements_order_idx")
  @@map("entitlements")
  @@schema("finance")
}

model FinanceDownloadUsageDaily {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  dateKey   String   @map("date_key") @db.VarChar(10)
  usedFree  Int      @default(0) @map("used_free")
  usedSub   Int      @default(0) @map("used_sub")
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  user      User     @relation("FinanceDownloadUsageDaily_user", fields: [userId], references: [id])

  @@unique([userId, dateKey])
  @@map("download_usage_daily")
  @@schema("finance")
}

model FinanceDownloadLog {
  id             String                   @id @default(uuid()) @db.Uuid
  userId         String                   @map("user_id") @db.Uuid
  productId      BigInt                   @map("product_id")
  dateTime       DateTime                 @default(now()) @map("date_time") @db.Timestamptz(6)
  dateKey        String                   @map("date_key") @db.VarChar(10)
  source         FinanceEntitlementSource
  subscriptionId String?                  @map("subscription_id") @db.Uuid
  orderId        String?                  @map("order_id") @db.Uuid
  user           User                     @relation("FinanceDownloadLog_user", fields: [userId], references: [id])
  product        Product                  @relation("FinanceDownloadLog_product", fields: [productId], references: [id])

  @@index([userId, dateKey])
  @@map("download_logs")
  @@schema("finance")
}

model FinanceSubscriptionPlan {
  id             String                      @id @default(uuid()) @db.Uuid
  code           FinanceSubscriptionPlanCode @unique
  dailySubLimit  Int                         @map("daily_sub_limit")
  dailyFreeLimit Int                         @map("daily_free_limit")
  isActive       Boolean                     @default(true) @map("is_active")
  createdAt      DateTime                    @default(now()) @map("created_at") @db.Timestamptz(6)
  subscriptions  FinanceUserSubscription[]
  purchases      FinanceSubscriptionPurchase[]

  @@map("subscription_plans")
  @@schema("finance")
}

model FinanceDonation {
  id             String                 @id @default(uuid()) @db.Uuid
  userId         String?                @map("user_id") @db.Uuid
  amount         Int
  status         FinanceDonationStatus
  gatewayTrackId String?                @map("gateway_track_id") @db.VarChar(128)
  referenceId    String?                @map("reference_id") @db.VarChar(128)
  createdAt      DateTime               @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime               @updatedAt @map("updated_at") @db.Timestamptz(6)
  user           User?                  @relation("FinanceDonation_user", fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId, createdAt])
  @@map("donations")
  @@schema("finance")
}

model FinanceUserSubscription {
  id        String                    @id @default(uuid()) @db.Uuid
  userId    String                    @map("user_id") @db.Uuid
  planId    String                    @map("plan_id") @db.Uuid
  startAt   DateTime                  @map("start_at") @db.Timestamptz(6)
  endAt     DateTime                  @map("end_at") @db.Timestamptz(6)
  status    FinanceSubscriptionStatus
  createdAt DateTime                  @default(now()) @map("created_at") @db.Timestamptz(6)
  plan      FinanceSubscriptionPlan   @relation(fields: [planId], references: [id])
  user      User                      @relation("FinanceUserSubscription_user", fields: [userId], references: [id])

  @@index([userId, endAt])
  @@map("user_subscriptions")
  @@schema("finance")
}

model FinanceSubscriptionPurchase {
  id             String                           @id @default(uuid()) @db.Uuid
  userId         String                           @map("user_id") @db.Uuid
  planId         String                           @map("plan_id") @db.Uuid
  status         FinanceSubscriptionPurchaseStatus @default(PENDING)
  amount         Int
  currency       String                           @db.VarChar(8)
  durationMonths Int                              @default(1) @map("duration_months")
  createdAt      DateTime                         @default(now()) @map("created_at") @db.Timestamptz(6)
  paidAt         DateTime?                        @map("paid_at") @db.Timestamptz(6)
  paymentId      String?                          @map("payment_id") @db.Uuid
  user           User                             @relation(fields: [userId], references: [id])
  plan           FinanceSubscriptionPlan          @relation(fields: [planId], references: [id])
  payment        FinancePayment?                  @relation(fields: [paymentId], references: [id])

  @@index([userId, createdAt], map: "subscription_purchases_user_id_created_at_idx")
  @@index([planId], map: "subscription_purchases_plan_id_idx")
  @@index([paymentId], map: "subscription_purchases_payment_id_idx")
  @@map("subscription_purchases")
  @@schema("finance")
}

model FinanceSubscriptionRevenuePool {
  id                  String                               @id @default(uuid()) @db.Uuid
  periodStart         DateTime                             @map("period_start") @db.Date
  periodEnd           DateTime                             @map("period_end") @db.Date
  totalRevenue        Int                                  @map("total_revenue")
  platformShareAmount Int                                  @map("platform_share_amount")
  distributableAmount Int                                  @map("distributable_amount")
  status              FinanceRevenuePoolStatus
  createdAt           DateTime                             @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime                             @updatedAt @map("updated_at") @db.Timestamptz(6)
  earnings            FinanceSubscriptionSupplierEarning[]

  @@unique([periodStart, periodEnd])
  @@map("subscription_revenue_pools")
  @@schema("finance")
}

model FinanceSubscriptionSupplierEarning {
  id              String                         @id @default(uuid()) @db.Uuid
  poolId          String                         @map("pool_id") @db.Uuid
  supplierId      String                         @map("supplier_id") @db.Uuid
  downloadsCredit Decimal                        @map("downloads_credit") @db.Decimal(10, 2)
  amount          Int
  status          FinanceEarningStatus
  payoutId        String?                        @map("payout_id") @db.Uuid
  createdAt       DateTime                       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime                       @updatedAt @map("updated_at") @db.Timestamptz(6)
  pool            FinanceSubscriptionRevenuePool @relation(fields: [poolId], references: [id], onDelete: Cascade)
  supplier        User                           @relation("FinanceSubscriptionSupplierEarning_supplier", fields: [supplierId], references: [id])
  payout          FinanceSupplierPayout?         @relation(fields: [payoutId], references: [id])

  @@index([supplierId])
  @@map("subscription_supplier_earnings")
  @@schema("finance")
}

model FinanceSupplierPayout {
  id                   String                               @id @default(uuid()) @db.Uuid
  supplierId           String                               @map("supplier_id") @db.Uuid
  amount               Int
  periodStart          DateTime?                            @map("period_start") @db.Date
  periodEnd            DateTime?                            @map("period_end") @db.Date
  status               FinancePayoutStatus
  reference            String?                              @db.VarChar(128)
  createdAt            DateTime                             @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime                             @updatedAt @map("updated_at") @db.Timestamptz(6)
  supplier             User                                 @relation(fields: [supplierId], references: [id])
  subscriptionEarnings FinanceSubscriptionSupplierEarning[]
  orderSplits          FinanceOrderRevenueSplit[]

  @@index([supplierId, status])
  @@map("supplier_payouts")
  @@schema("finance")
}

model FinanceOrderRevenueSplit {
  id              String                        @id @default(uuid()) @db.Uuid
  orderId         String                        @map("order_id") @db.Uuid
  productId       BigInt                        @map("product_id")
  beneficiaryType FinanceRevenueBeneficiaryType @map("beneficiary_type")
  supplierId      String?                       @map("supplier_id") @db.Uuid
  amount          Int
  payoutId        String?                       @map("payout_id") @db.Uuid
  createdAt       DateTime                      @default(now()) @map("created_at") @db.Timestamptz(6)
  order           FinanceOrder                  @relation("FinanceOrder_revenue_splits", fields: [orderId], references: [id], onDelete: Cascade)
  product         Product                       @relation("FinanceOrderRevenueSplit_product", fields: [productId], references: [id])
  payout          FinanceSupplierPayout?        @relation(fields: [payoutId], references: [id])

  @@unique([orderId, productId, beneficiaryType, supplierId])
  @@index([orderId])
  @@index([supplierId])
  @@map("order_revenue_splits")
  @@schema("finance")
}

model OrderRequest {
  id               String        @id @default(uuid()) @db.Uuid
  fullName         String        @map("full_name") @db.VarChar(255)
  messenger        Messenger
  phoneNumber      String        @map("phone_number") @db.VarChar(32)
  description      String?       @db.VarChar(2000)
  imageCount       Int           @map("image_count")
  amountToman      Int           @map("amount_toman")
  fileUrl          String        @map("file_url") @db.VarChar(1000)
  fileSource       String?       @map("file_source") @db.VarChar(64)
  fileKind         OrderFileKind? @map("file_kind")
  originalFileName String?       @map("original_file_name") @db.VarChar(255)
  fileMimeType     String?       @map("file_mime_type") @db.VarChar(128)
  fileSize         Int?          @map("file_size")
  storageKey       String?       @map("storage_key") @db.VarChar(500)
  payment          Payment?
  createdAt        DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime      @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([createdAt], map: "order_requests_created_at_idx")
  @@map("order_requests")
  @@schema("public")
}

model Payment {
  id             String        @id @default(uuid()) @db.Uuid
  orderRequestId String?       @unique @map("order_request_id") @db.Uuid
  orderRequest   OrderRequest? @relation(fields: [orderRequestId], references: [id], onDelete: SetNull)
  gateway        String        @db.VarChar(32)
  purpose        OrderRequestPaymentPurpose @default(PHOTO_RESTORE)
  amountToman    Int           @map("amount_toman")
  status         PaymentStatus @default(PENDING)
  trackId        String?       @unique @map("track_id") @db.VarChar(64)
  transactionId  String?       @map("transaction_id") @db.VarChar(128)
  redirectUrl    String?       @map("redirect_url") @db.VarChar(512)
  result         Int?          @map("result")
  message        String?       @db.VarChar(512)
  orderDraft     Json?         @map("order_draft")
  rawRequest     Json?         @map("raw_request")
  rawVerify      Json?         @map("raw_verify")
  createdAt      DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime      @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([trackId], map: "order_request_payments_track_idx")
  @@map("order_request_payments")
  @@schema("public")
}
